WITH ARC1cte AS
(SELECT 'Moseley AR Aging' as "Company", CUSNO AS CustomerNumber, bfhitx AS "Customer Name", sum(OUTAR ) AS "Total"
FROM amflib1.OPENAR
JOIN amflib1.MBBFREs2 ON amflib1.MBBFREs2.bfcanb=amflib1.openar.CUSNO 
JOIN amflib1.MBDYREP ON amflib1.MBBFREs2.bfblcd=amflib1.MBDYREP.DYBLCD
WHERE OUTAR <>0
GROUP BY comno, cusno, bfhitx),
ARC5cte as 
(SELECT 'CarrierComm AR Aging' AS "Company", CUSNO AS CustomerNumber, bfhitx AS "Customer Name", 
sum(OUTAR ) AS "Total"
FROM amflib5.OPENAR
JOIN amflib5.MBBFREs2 ON amflib5.MBBFREs2.bfcanb=amflib5.openar.CUSNO 
JOIN amflib5.MBDYREP ON amflib5.MBBFREs2.bfblcd=amflib5.MBDYREP.DYBLCD
WHERE OUTAR <>0
GROUP BY comno, cusno, bfhitx),
ARCActe as
(SELECT 'E-Band AR Aging' AS "Company", CUSNO AS CustomerNumber, bfhitx AS "Customer Name", 
sum(OUTAR ) AS "Total"
FROM AMFLIBA.OPENAR
JOIN AMFLIBA.MBBFREs2 ON AMFLIBA.MBBFREs2.bfcanb=AMFLIBA.openar.CUSNO 
JOIN AMFLIBA.MBDYREP ON AMFLIBA.MBBFREs2.bfblcd=AMFLIBA.MBDYREP.DYBLCD
WHERE OUTAR <>0
GROUP BY comno, cusno, bfhitx),
ARCBcte as
(SELECT 'REMEC AR Aging' AS "Company", CUSNO AS CustomerNumber, bfhitx AS "Customer Name", 
sum(OUTAR ) AS "Total"
FROM AMFLIBb.OPENAR
JOIN AMFLIBb.MBBFREs2 ON AMFLIBb.MBBFREs2.bfcanb=AMFLIBb.openar.CUSNO 
JOIN AMFLIBb.MBDYREP ON AMFLIBb.MBBFREs2.bfblcd=AMFLIBb.MBDYREP.DYBLCD
WHERE OUTAR <>0
GROUP BY comno, cusno, bfhitx),
BEGBALcte 
AS
(SELECT  COMNO, GLANO,  BALFD -BALFC AS BegBal
FROM amflib1.GELMAS
WHERE GLTYP = 1 AND BALFD-BALFC <>0
UNION
SELECT  COMNO, GLANO,  BALFD -BALFC AS BegBal
FROM amflib4.GELMAS
WHERE GLTYP = 1 AND BALFD-BALFC <>0
UNION 
SELECT  COMNO, GLANO,  BALFD -BALFC AS BegBal
FROM amflib5.GELMAS
WHERE GLTYP = 1 AND BALFD-BALFC <>0
UNION 
SELECT  COMNO, GLANO,  BALFD -BALFC AS BegBal
FROM amflib6.GELMAS
WHERE GLTYP = 1 AND BALFD-BALFC <>0
UNION 
SELECT  COMNO, GLANO,  BALFD -BALFC AS BegBal
FROM amflib7.GELMAS
WHERE GLTYP = 1 AND BALFD-BALFC <>0
UNION 
SELECT  COMNO, GLANO,  BALFD -BALFC AS BegBal
FROM amflib8.GELMAS
WHERE GLTYP = 1 AND BALFD-BALFC <>0
UNION 
SELECT  COMNO, GLANO,  BALFD -BALFC AS BegBal
FROM amflib9.GELMAS
WHERE GLTYP = 1 AND BALFD-BALFC <>0
UNION 
SELECT  COMNO, GLANO,  BALFD -BALFC AS BegBal
FROM amfliba.GELMAS
WHERE GLTYP = 1 AND BALFD-BALFC <>0
UNION
SELECT  COMNO, GLANO,  BALFD -BALFC AS BegBal
FROM amflibb.GELMAS
WHERE GLTYP = 1 AND BALFD-BALFC <>0),
GLcte as
(SELECT EMNTH, JRFNO, COMNO, GLANO, EYEAR,
CASE WHEN DRCRC ='C' THEN -1*GLAMT 
ELSE GLAMT 
END AS NormalizedAmount
FROM AMFLIB1.TEMGEN
UNION
SELECT EMNTH, JRFNO, COMNO, GLANO, EYEAR,
CASE WHEN DRCRC ='C' THEN -1*GLAMT 
ELSE GLAMT 
END AS NormalizedAmount
FROM amflib1.CURHIS
UNION
SELECT EMNTH, JRFNO, COMNO, GLANO, EYEAR,
CASE WHEN DRCRC ='C' THEN -1*GLAMT 
ELSE GLAMT 
END AS NormalizedAmount
FROM AMFLIB4.TEMGEN
UNION
SELECT EMNTH, JRFNO, COMNO, GLANO, EYEAR,
CASE WHEN DRCRC ='C' THEN -1*GLAMT 
ELSE GLAMT 
END AS NormalizedAmount
FROM amflib4.CURHIS
UNION
SELECT EMNTH, JRFNO, COMNO, GLANO, EYEAR,
CASE WHEN DRCRC ='C' THEN -1*GLAMT 
ELSE GLAMT 
END AS NormalizedAmount
FROM AMFLIB5.TEMGEN
UNION
SELECT EMNTH, JRFNO, COMNO, GLANO, EYEAR,
CASE WHEN DRCRC ='C' THEN -1*GLAMT 
ELSE GLAMT 
END AS NormalizedAmount
FROM amflib5.CURHIS
UNION
SELECT EMNTH, JRFNO, COMNO, GLANO, EYEAR,
CASE WHEN DRCRC ='C' THEN -1*GLAMT 
ELSE GLAMT 
END AS NormalizedAmount
FROM AMFLIBa.TEMGEN
UNION
SELECT EMNTH, JRFNO, COMNO, GLANO, EYEAR,
CASE WHEN DRCRC ='C' THEN -1*GLAMT 
ELSE GLAMT 
END AS NormalizedAmount
FROM amfliba.CURHIS
UNION
SELECT EMNTH, JRFNO, COMNO, GLANO, EYEAR,
CASE WHEN DRCRC ='C' THEN -1*GLAMT 
ELSE GLAMT 
END AS NormalizedAmount
FROM AMFLIBb.TEMGEN
UNION
SELECT EMNTH, JRFNO, COMNO, GLANO, EYEAR,
CASE WHEN DRCRC ='C' THEN -1*GLAMT 
ELSE GLAMT 
END AS NormalizedAmount
FROM amflibb.CURHIS
UNION
SELECT EMNTH, JRFNO, COMNO, GLANO, EYEAR,
CASE WHEN DRCRC ='C' THEN -1*GLAMT 
ELSE GLAMT 
END AS NormalizedAmount
FROM AMFLIB6.TEMGEN
UNION
SELECT EMNTH, JRFNO, COMNO, GLANO, EYEAR,
CASE WHEN DRCRC ='C' THEN -1*GLAMT 
ELSE GLAMT 
END AS NormalizedAmount
FROM amflib6.CURHIS
UNION
SELECT EMNTH, JRFNO, COMNO, GLANO, EYEAR,
CASE WHEN DRCRC ='C' THEN -1*GLAMT 
ELSE GLAMT 
END AS NormalizedAmount
FROM AMFLIB8.TEMGEN
UNION
SELECT EMNTH, JRFNO, COMNO, GLANO, EYEAR,
CASE WHEN DRCRC ='C' THEN -1*GLAMT 
ELSE GLAMT 
END AS NormalizedAmount
FROM amflib8.CURHIS
UNION
SELECT EMNTH, JRFNO, COMNO, GLANO, EYEAR,
CASE WHEN DRCRC ='C' THEN -1*GLAMT 
ELSE GLAMT 
END AS NormalizedAmount
FROM AMFLIB9.TEMGEN
UNION
SELECT EMNTH, JRFNO, COMNO, GLANO, EYEAR,
CASE WHEN DRCRC ='C' THEN -1*GLAMT 
ELSE GLAMT 
END AS NormalizedAmount
FROM amflib9.CURHIS),
TOTALGLcte as
(SELECT 0 AS Period, COMNO, trim(GLANO) AS Account, BEGBAL AS Total
FROM BEGBALcte
UNION all
SELECT EMNTH AS Period, COMNO, trim(GLANO) AS Account, NormalizedAmount AS Total
FROM GLcte
-- Change year to last year to exclude it (current year is 120, 0 and 20 format depending on what company)
WHERE EYEAR <> 120 and EYEAR <> 119),
REPORTcte AS 
(SELECT "Company", sum("Total") AS Total
FROM ARC1cte
GROUP BY "Company"
union
SELECT "Company", sum("Total")
FROM ARC5cte
GROUP BY "Company"
UNION 
SELECT "Company", sum("Total")
FROM ARCActe
GROUP BY "Company"
UNION 
SELECT "Company", sum("Total")
FROM ARCBcte
GROUP BY "Company"
UNION 
SELECT 'CarrierComm GL', sum(Total) AS Total
FROM TOTALGLcte
WHERE COMNO = 5 AND Account = 1203
UNION 
SELECT 'E-Band GL', sum(Total) AS Total
FROM TOTALGLcte
WHERE COMNO = 10 AND Account = 1203
UNION 
SELECT 'REMEC GL', sum(Total) AS Total
FROM TOTALGLcte
WHERE COMNO = 11 AND Account = 1203
UNION 
SELECT 'Moseley GL', sum(Total) AS Total
FROM TOTALGLcte
WHERE COMNO = 1 AND Account = 1203)
SELECT *
FROM REPORTcte
ORDER BY "Company"
